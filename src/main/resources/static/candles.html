<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Trader</title>
    <script src="jquery-1.9.1.js"></script>
    <script src="jquery.flot.js"></script>
    <script src="jquery.flot.time.js"></script>
  </head>

<script type="text/javascript">
  /* for local testing */ if (window.location.origin == "file://") $.getScript("../../../test/resources/testdata.js", refreshData)

  $(document).ready(function() {
    refreshData();
  });

  var advisor;
  var data;

  var grid = {
    xStart: getWeekStart(),
    xEnd: getWeekEnd()
  }
  var options = {
    series: {
      lines: { show: true },
      points: { show: false }
    },
    xaxis : {
      mode: 'time',
      timeformat: "%a %H:%M %d.%m %Y",
      timezone: 'browser'
    }
  }

  function moveToNowWindow() {
    refreshData()
  }

  function moveToPreviousWindow() {
    console.log("back")
  }

  function moveToNextWindow() {
    console.log("forth")
  }

  function refreshData() {
    readHistory()
    readAdvisor()
    calibrateChart()
    calibrateGrid()
    displayChart()
  }

  function readHistory() {
    $.ajax({
      url: "candles.json?week=0",
      dataType: "json",
      async: false
    }).done(function(d) { data = d });
  }

  function readAdvisor() {
    $.ajax({
      url: "advisor.json?week=0",
      dataType: "json",
      async: false
    }).done(function(data) { advisor = data });
  }

  function calibrateChart() {
    var tickSize = Math.ceil(5000 / $('body').innerWidth())
    tickSize = Math.ceil(24 / Math.floor(24 / tickSize))
    options.xaxis.tickSize = [ tickSize, 'hour']

    options.xaxis.min = Math.floor(grid.xStart / 3600000) * 3600000;
  }

  function calibrateGrid() {
    var floor = 0
    var ceiling = 0
    for (i in data) {
      if ((grid.xStart <= data[i].timestamp) && (data[i].timestamp <= grid.xEnd)) {
        floor = floor ? Math.min(floor, data[i].low) : data[i].low;
        ceiling = ceiling ? Math.max(ceiling, data[i].high) : data[i].high;
      }
    }

    var mid = (floor + ceiling) / 2
    if (advisor) {
      for (i in advisor) {
        floor = floor ? Math.min(floor, mid - advisor[i].watchpips - 5) : mid - advisor[i].watchpips - 5;
        ceiling = ceiling ? Math.max(ceiling, mid + advisor[i].watchpips + 5) : mid + advisor[i].watchpips + 5;
      }
    }

    grid.yMin = Math.floor(floor / 100) * 100 + 10
    grid.yMax = Math.ceil(ceiling / 100) * 100 - 10
    grid.yMid = (grid.yMin + grid.yMax) / 2
  }

  function displayChart() {
    var plot = []
    var series = []

    frameMarketHours(plot)

    for (i in data) {
      if ((grid.xStart <= data[i].timestamp) && (data[i].timestamp <= grid.xEnd)) {
        series.push([ data[i].timestamp, data[i].open ])
        series.push([ data[i].timestamp, data[i].high ])
        series.push([ data[i].timestamp, data[i].low ])
        series.push([ data[i].timestamp, data[i].close ])
      }
    }

    plot.push({ data: series, color: 'green' });

    // show advisor advice
    if (advisor) {
      for (i in advisor) {
        plot.push(newFrame(advisor[i].watchtime, advisor[i].closetime, grid.yMin + 5, grid.yMax - 5, 'blue'))
        plot.push(newFrame(advisor[i].watchtime, advisor[i].opentime, grid.yMid + advisor[i].watchpips, grid.yMid - advisor[i].watchpips, 'blue'))
      }
    }

    // draw
    $("#chart").empty()
      .width($('body').innerWidth()).height($('body').innerHeight())
      .plot(plot, options).data("plot");
  }

  // Market hours (GMT):
  // Sydney:   10:00 pm - 07:00 am
  // Tokyo:    00:00 am - 09:00 am
  // London:   08:00 am - 05:00 pm
  // New York: 01:00 pm – 10:00 pm
  function frameMarketHours(plot) {
    var offset = - new Date().getTimezoneOffset()
    var d = new Date(grid.xStart + offset * 60000)
    d.setDate(d.getDate() - d.getDay() + 0)
    d.setHours(22)
    d.setMinutes(offset)
    grid.marketStart = d.getTime()

    d.setDate(d.getDate() - d.getDay() + 5)
    d.setHours(22)
    d.setMinutes(offset)
    grid.marketEnd = d.getTime()

    plot.push(newFrame(grid.marketStart, grid.marketEnd, grid.yMin, grid.yMax, 'black'))

    plot.push({ data: [ [grid.xStart, grid.yMid], [grid.marketStart, grid.yMid] ], color: 'black' });
    plot.push({ data: [ [grid.marketEnd, grid.yMid], [grid.xEnd, grid.yMid] ], color: 'black' });
  }

  function newFrame(x1, x2, y1, y2, color) {
    return { data: [ [x1, y1], [x1, y2], [x2, y2], [x2, y1], [x1, y1] ], color: color }
  }

  function getWeekStart() {
    var d = new Date();
    d.setDate(d.getDate() - d.getDay());
    d.setHours(0);
    d.setMinutes(0);
    return d.getTime()
  }

  function getWeekEnd() {
    var d = new Date(getWeekStart());
    d.setDate(d.getDate() + 7);
    return d.getTime()
  }
</script>

 <body>
  <div id="chart"></div>

  <div style="position:absolute; top:3px; left:100px; z-index:10; background-color:white; border: 2px solid black;">
   <input type="button" value="Now" onClick="javascript:moveToNowWindow()" />
   &nbsp;
   <input type="button" value="Back" onClick="javascript:moveToPreviousWindow()" />
   &nbsp;
   Moon sign: <span id="moon_sign">?</span>
   &nbsp;
   Moon aspect: <span id="moon_aspect">?</span>
   &nbsp;
   <input type="button" value="Forth" onClick="javascript:moveToNextWindow()" />
  </div>
 </body>

</html>